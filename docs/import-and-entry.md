# CSVインポート & 手入力フロー案

## 目的
- 銀行・クレカ明細を CSV で取り込み、仕訳生成の手間を削減。
- 完全手入力もサポートし、CSV が用意できないケースにも対応。

## CSV インポート

### 対応範囲
- 銀行入出金、クレジットカード利用明細。
- 初期は主要フォーマットに絞り、共通テンプレートを案内。

### ファイル仕様
- UTF-8 / Shift_JIS いずれも対応（自動判定を実装）。
- 列例（共通テンプレート）
  - `transaction_date` (YYYY-MM-DD)
  - `amount` (数値、支出は負値も可)
  - `description`
  - `counterparty`
  - `category_hint` (任意)
  - `memo` (任意)
- フォーマット差異の吸収
  - 取引日・金額・摘要カラムをユーザーにマッピングさせる UI を用意。
  - 列変換マッピングは事業所ごとに保存し次回以降再利用。

### 処理フロー
1. ユーザーが CSV をアップロード。
2. サーバー側でバリデーション（行数上限、必須列、日付/金額の整合性）。
3. 正常行を `transactions` テーブルに pending 状態で格納。
4. 既存取引との重複チェック（同日・金額・摘要一致など）→ 重複候補は要確認リストに表示。
5. ユーザーが仕訳候補を確認。
   - カテゴリ自動提案: 過去の学習結果/辞書ルール。
   - 税区分判定: `tax_categories` + `tax_rates` から算出。
6. 承認後、仕訳 (`journal_entries` + `lines`) を自動生成し、取引を `matched` 状態に更新。
7. OCR領収書との突合があればリンク。

### エラーハンドリング
- バリデーション失敗行は一覧表示し、ユーザーが編集→再インポート。
- CSV が大きい場合はバッチ処理しレスポンスを分割返却。

## 手入力フロー

### 仕訳入力
- 日付・借方勘定・貸方勘定・金額・摘要・税区分を入力する基本フォーム。
- テンプレート機能: 定期発生仕訳を登録しておき、ワンクリックで展開。
- 税込/税抜は business 設定に従い自動換算。

### 取引入力
- 銀行口座残高管理のため、手入力で取引登録→仕訳化。
- スマホ UI: 金額・日付・カテゴリを大きな入力 UI に。

### 重複チェック
- 同じ日付・金額・カテゴリの仕訳がある場合は警告。
- 取引→仕訳のマッチング時に既存仕訳があるとアラート表示。

## 設定項目
- 取引マッピング: CSV カラムとアプリ内フィールドの対応表。
- 仕訳テンプレート: 名前、借方科目、貸方科目、税区分、金額割合など。
- 税分類ルール: `category_hint` や摘要キーワードに基づく税区分自動設定。

## 将来拡張
- API 連携（公式オープンバンキング）導入時も `transactions` テーブルの同フローを再利用。
- AI によるカテゴリー自動判定（学習モデル）追加。
- 複数 CSV の同時インポート、zip アップロード対応。
