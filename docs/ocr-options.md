# OCR / AI 候補メモ

## 目的
- 領収書画像から日付・金額・取引先・税率等を抽出。
- 完全無料〜低コストで開始し、精度が必要になれば有償へ移行。

## 候補サービス

### 1. Google Cloud Vision API
- 無料枠: 月 1000 ユニット（ただしアカウント作成時クレカ登録必須）。
- 日本語対応: OCR は十分。ただし構造化抽出は追加実装が必要。
- 実装: HTTP REST。Vercel Edge からの直接呼び出しは要認証管理。
- 懸念: 無料枠超過時は従量課金。請求先設定が必要。

### 2. Microsoft Azure Form Recognizer (Document Intelligence)
- 無料枠: 月 500 ページ。（Azure サブスクリプション必要）
- 英語中心だが日本語領収書も一定精度。
- テンプレート学習機能あり。
- 懸念: サブスクリプション維持コスト、Vercel からの秘密管理。

### 3. Amazon Textract
- 無料枠: 3 か月間、月 1000 ページ。AWS アカウント必須。
- 日本語サポートは限定的。構造化結果 JSON。
- 無料期間後は課金。

### 4. Open Source (Tesseract OCR)
- 完全無料。
- Vercel Functions では重いので外部ワーカーが必要。
- 日本語辞書同梱で精度は限定。
- 画像ノイズ除去など前処理が必須。

### 5. Nanonets / OCR.Space 等のフリープラン
- 一定枚数までは無料。
- API キーで利用可能。
- 長期的な安定性や SLA は不明。

## 推奨アプローチ
1. **PoC**: `OCR.Space` や `Tesseract` + 追加加工で検証。無料枠で技術検証。
2. **本番初期**: Google Vision もしくは Azure Form Recognizer を候補。無料枠内で回るユーザー数（1〜5 名）なら現実的。
3. **将来**: 自前モデル fine-tuning や、有償SaaS（Moneytree OCR 連携等）を検討。

## 実装メモ
- OCR 結果は `receipts.ocr_payload` (JSONB) に保存。再解析時はバージョン管理。
- データ抽出ロジック
  - 日付: 正規表現 + 解析スコアで最有力候補。
  - 金額: 税込/税抜金額の推定。複数候補の場合ユーザー確認。
  - 取引先: 固有名詞抽出。
- 重複検知
  - 同額・同日・同取引先の既存仕訳/取引を提示。

## 懸念事項
- 外部APIキー管理: Vercel 環境変数で安全に保管。
- 無料枠超過時のフェイルセーフ: 手入力へフォールバックし、ユーザーに通知。
- 法的配慮: OCR結果を海外リージョンで処理する際の個人情報保護確認。
