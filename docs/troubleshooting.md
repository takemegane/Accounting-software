# トラブルシューティングメモ

## 2024-10-06 税区分 API 取得失敗による画面停止
- **症状**: 設定・取引画面で「読み込み中...」の表示が消えず操作不能になる。ブラウザネットワークには `/api/tax-categories` へのリクエストが複数回再試行されている。
- **原因**: 新規実装した税区分 API が Prisma を含む Node ランタイム前提であるにもかかわらず、実行環境により 500 エラーが発生し、React Query が再試行を続けていた。UI 側は税区分の取得結果のみを前提にしていたため、失敗時でもローディング状態が継続していた。
- **対応**:
  - API を `runtime = "nodejs"` / `dynamic = "force-dynamic"` に固定し、失敗時は 500 を返してログ化。
  - フロントエンドで `retry: false` とし、失敗時はアラート表示と勘定科目に付随する税区分情報をフォールバックとして利用。
  - 仕訳入力・勘定科目管理の UI を改修し、税区分取得に失敗しても既存データで操作を継続可能に。
- **再発防止**:
  1. Prisma を利用する App Router/API では明示的に Node ランタイムを指定する。
  2. マスター系 API を利用する画面はエラーハンドリングとフォールバックデータを必ず実装する。

## 2024-10-06 ハッシュ化済みチャンク (./682.js) を読み込めずダッシュボードが 500 になる
- **症状**: `next dev` 起動後にダッシュボードへアクセスすると `Cannot find module './682.js'` で 500 エラー。
- **原因**: 直前に `next build` を実行したことで `.next` に本番ビルド成果物が残存し、開発サーバー起動時に古いハッシュ付き JS を参照していた。
- **対応**: `.next` ディレクトリを削除してから `next dev` を起動。再発防止として `npm run clean` スクリプトと README の手順を追加。
- **再発防止**: 開発サーバー実行前に `.next` を削除するか `npm run clean` を実行してキャッシュをリセットする。
