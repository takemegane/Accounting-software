# 会計ソフトウェア 開発マニュアル

## 最新の機能追加（2025-10-09）

### 仕訳登録のレスポンス改善と要確認一覧機能

#### 実装の背景
仕訳登録ボタンを押した後のレスポンスが遅く、ユーザー体験が悪かったため、Optimistic UIパターンを採用してレスポンス改善を実施しました。

#### 実装内容

##### 1. Optimistic UI（楽観的UI更新）の実装
- **目的**: 仕訳登録時の即座のフィードバック提供
- **動作**:
  - 「仕訳を登録」ボタンをクリックすると、即座にフォームがクリアされる
  - バックグラウンドでサーバーへの登録処理を実行
  - 成功時: 「仕訳を登録しました」メッセージを3秒間表示
  - 失敗時: エラーメッセージを5秒間表示し、失敗した仕訳を要確認一覧に追加
- **適用範囲**: 新規作成時のみ（編集モードでは従来通りの動作）

##### 2. 要確認一覧タブの追加
- **目的**: 登録に失敗した仕訳を後で確認・再入力できるようにする
- **場所**: 取引画面のタブバーに独立したタブとして追加
  - タブ構成: 「仕訳入力」「CSVインポート」「仕訳一覧」「要確認一覧」
- **表示内容**:
  - 失敗した仕訳の一覧（新しい順）
  - 各エラー項目に表示される情報:
    - エラー発生日時
    - エラーメッセージ
    - 仕訳の詳細（日付、摘要、勘定科目、借方、貸方、メモ）
  - 操作ボタン:
    - 「再入力する」: 編集フォームに仕訳内容を復元
    - 「×」: 個別削除
    - 「全て削除」: 一括削除

#### 実装ファイル

##### 新規作成ファイル

**`components/failed-entries-context.tsx`**
- 役割: 失敗した仕訳の状態管理（React Context）
- 提供する機能:
  ```typescript
  - failedEntries: FailedEntry[] // 失敗仕訳の配列
  - addFailedEntry: (entry) => void // 失敗仕訳を追加
  - removeFailedEntry: (id) => void // 指定IDの失敗仕訳を削除
  - clearAllFailedEntries: () => void // 全ての失敗仕訳を削除
  ```
- データ構造:
  ```typescript
  type FailedEntry = {
    id: string;           // 一意のID
    timestamp: number;    // 登録時刻
    date: string;         // 仕訳日付
    description: string;  // 摘要
    lines: FailedEntryLine[]; // 仕訳明細
    error: string;        // エラーメッセージ
  };
  ```

**`components/failed-entries-list.tsx`**
- 役割: 要確認一覧の表示コンポーネント
- 機能:
  - 失敗仕訳の一覧表示
  - 「再入力する」ボタン → 編集フォームに復元
  - 個別削除・一括削除機能
  - 失敗件数のバッジ表示
- スタイリング: 赤系の配色で警告を視覚的に表現

##### 変更ファイル

**`components/journal-entry-form.tsx`**
- 変更点:
  1. `useFailedEntries` フックを追加
  2. `handleSubmit` 関数の修正:
     - 編集モード: 従来通りの動作（レスポンス待ち）
     - 新規作成モード: Optimistic UI実装
       ```typescript
       // 入力内容を保存
       const savedEntry = { date, description, lines };

       // 即座にフォームをクリア
       setDescription("");
       setLines(createInitialLines());
       setMessage("登録中...");

       // バックグラウンドで登録処理
       mutation.mutate({ mode: "create" }, {
         onSuccess: () => {
           setMessage("仕訳を登録しました");
           setTimeout(() => setMessage(null), 3000);
         },
         onError: (error) => {
           addFailedEntry({ ...savedEntry, error: error.message });
           setError("仕訳の登録に失敗しました。要確認一覧をご確認ください。");
           setTimeout(() => setError(null), 5000);
         },
       });
       ```

**`app/transactions/page.tsx`**
- 変更点:
  1. `FailedEntriesProvider` でコンテンツをラップ
  2. タブ定義に `"failed"` を追加
  3. レイアウト変更:
     - 仕訳一覧タブ: `TransactionsTable` のみ表示
     - 要確認一覧タブ: `FailedEntriesList` を独立表示

#### 技術的なポイント

##### Optimistic UIパターンのメリット
1. **即座のフィードバック**: ユーザーは待ち時間なく次の操作に移れる
2. **UX向上**: サーバーレスポンスを待たずに操作を継続できる
3. **生産性向上**: 連続して仕訳を入力する際に効率的

##### エラー処理の工夫
1. **データ保持**: 失敗した仕訳の内容を完全に保持
2. **復元機能**: ワンクリックで編集フォームに復元可能
3. **視覚的フィードバック**: 赤色の警告UIで失敗を明確に表示
4. **後回し可能**: エラー発生時も作業を中断せず、後で対処できる

##### 状態管理
- React Contextを使用して、コンポーネント間で失敗仕訳の状態を共有
- Provider構造:
  ```
  FailedEntriesProvider
    └─ JournalEntryEditorProvider
        └─ TransactionsContent
            ├─ JournalEntryForm (エラー時に追加)
            └─ FailedEntriesList (一覧表示・再入力)
  ```

#### 使用方法

##### 通常の使用フロー
1. 「仕訳入力」タブで仕訳を入力
2. 「仕訳を登録」をクリック
3. フォームが即座にクリアされ、次の仕訳入力が可能
4. 成功: 「仕訳を登録しました」メッセージが表示される
5. 失敗: エラーメッセージが表示され、要確認一覧に追加される

##### エラー時の対処フロー
1. 「要確認一覧」タブを開く
2. 失敗した仕訳のエラー内容を確認
3. 「再入力する」ボタンをクリック
4. 編集フォームに内容が復元される
5. 必要に応じて修正し、再登録

#### Git履歴

```bash
# Optimistic UIと要確認一覧の実装
commit 82b06d5
- components/failed-entries-context.tsx 作成
- components/failed-entries-list.tsx 作成
- components/journal-entry-form.tsx 修正（Optimistic UI実装）
- app/transactions/page.tsx 修正（2カラムレイアウト）

# 要確認一覧を独立タブに変更
commit d8fe0b2
- app/transactions/page.tsx 修正（タブとして分離）
```

#### 今後の拡張可能性

##### 検討事項
1. **永続化**: LocalStorageやIndexedDBに失敗仕訳を保存し、ブラウザを閉じても保持
2. **自動再試行**: ネットワークエラーの場合、自動的に再試行
3. **バッチ処理**: 複数の失敗仕訳を一括で再登録
4. **通知機能**: 失敗件数が増えた際のバッジ表示やアラート

---

## 関連機能

### 仕訳入力フォーム
- 場所: `app/transactions/page.tsx` の「仕訳入力」タブ
- コンポーネント: `components/journal-entry-form.tsx`
- 機能:
  - 日付・摘要の入力
  - 複数明細行の入力（勘定科目、借方、貸方、メモ、税区分）
  - 消費税の自動計算・プレビュー
  - バリデーション（借方・貸方の合計一致確認）

### 仕訳一覧
- 場所: `app/transactions/page.tsx` の「仕訳一覧」タブ
- コンポーネント: `components/transactions-table.tsx`
- 機能:
  - 登録済み仕訳の一覧表示
  - 編集・削除機能
  - 会計期間ロック機能との連携

### CSVインポート
- 場所: `app/transactions/page.tsx` の「CSVインポート」タブ
- コンポーネント:
  - `components/csv-importer.tsx`
  - `components/imported-transactions.tsx`
- 機能:
  - CSVファイルから仕訳を一括インポート
  - インポート前のプレビュー・編集

---

## 開発環境

### 技術スタック
- **Framework**: Next.js 14.2.25
- **UI**: React 18
- **Database**: PostgreSQL (Prisma ORM)
- **State Management**: React Query (TanStack Query)
- **Style**: Inline styles (将来的にTailwind CSSへの移行検討)

### 開発サーバーの起動
```bash
cd "/Users/motoki/Desktop/Codex CLI/Accounting software"
npm run dev
```
- アクセスURL: http://localhost:3000

### データベース操作
```bash
# マイグレーション実行
npx prisma migrate dev

# Prisma Studioの起動（データベースGUI）
npx prisma studio
```

---

## トラブルシューティング

### 要確認一覧が表示されない
1. 開発サーバーが起動しているか確認
2. ブラウザをリロード（Cmd+R / Ctrl+R）
3. ブラウザのコンソールでエラーを確認

### 失敗仕訳が要確認一覧に追加されない
1. `FailedEntriesProvider` が正しくラップされているか確認
2. `journal-entry-form.tsx` で `useFailedEntries` フックが使用されているか確認
3. エラー発生時の `onError` コールバックが実行されているか確認

### 再入力ボタンが動作しない
1. `JournalEntryEditorProvider` が正しくラップされているか確認
2. `useJournalEntryEditor` フックが利用可能か確認

---

最終更新日: 2025-10-09
