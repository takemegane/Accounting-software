# 仕訳編集・削除機能 テスト計画

## 概要
レポート・帳簿画面から仕訳の編集・削除ができるようになりました。
データ整合性を保つため、以下の項目を確認してください。

## テストケース

### 1. 仕訳帳からの編集
**手順:**
1. http://localhost:3000/books にアクセス
2. 仕訳帳セクションで任意の仕訳の「編集」ボタンをクリック
3. ページ上部の仕訳入力フォームに内容が読み込まれることを確認
4. 金額や摘要を変更して「変更を保存」をクリック
5. 仕訳帳に反映されることを確認

**確認項目:**
- [ ] 編集ボタンクリック後、フォームにデータが正しく読み込まれる
- [ ] 税抜経理の場合、消費税が再計算される
- [ ] 借方・貸方の合計が一致している
- [ ] 仕訳帳の表示が更新される
- [ ] 総勘定元帳の表示も更新される

### 2. 仕訳帳からの削除
**手順:**
1. http://localhost:3000/books にアクセス
2. 仕訳帳セクションで任意の仕訳の「削除」ボタンをクリック
3. 確認ダイアログが表示されることを確認
4. 「削除する」をクリック
5. 仕訳が削除されることを確認

**確認項目:**
- [ ] 削除確認ダイアログが表示される
- [ ] 「キャンセル」で削除が中止される
- [ ] 「削除する」で仕訳が削除される
- [ ] 仕訳帳から該当仕訳が消える
- [ ] 総勘定元帳からも該当仕訳が消える

### 3. 総勘定元帳からの編集
**手順:**
1. http://localhost:3000/books にアクセス
2. 総勘定元帳セクションで任意の仕訳行の「編集」ボタンをクリック
3. ページ上部の仕訳入力フォームに内容が読み込まれることを確認
4. 金額を変更して「変更を保存」をクリック
5. 総勘定元帳の残高が再計算されることを確認

**確認項目:**
- [ ] 編集ボタンクリック後、フォームにデータが正しく読み込まれる
- [ ] 残高が正しく再計算される
- [ ] 他の勘定科目の残高は変わらない（関係ない仕訳のみ）
- [ ] 仕訳帳の表示も更新される

### 4. 総勘定元帳からの削除
**手順:**
1. http://localhost:3000/books にアクセス
2. 総勘定元帳セクションで任意の仕訳行の「削除」ボタンをクリック
3. 確認ダイアログが表示されることを確認
4. 「削除する」をクリック
5. 該当仕訳が削除され、残高が再計算されることを確認

**確認項目:**
- [ ] 削除確認ダイアログが表示される
- [ ] 削除後、残高が正しく再計算される
- [ ] 仕訳帳からも該当仕訳が消える

### 5. データ整合性の確認
**手順:**
1. 仕訳を1件編集または削除
2. 以下のページを順番に確認:
   - ダッシュボード (http://localhost:3000)
   - 取引一覧 (http://localhost:3000/transactions)
   - 帳簿 (http://localhost:3000/books)
   - レポート (http://localhost:3000/reports)

**確認項目:**
- [ ] ダッシュボードの数値が更新される
- [ ] 仕訳帳の借方・貸方合計が一致している
- [ ] 総勘定元帳の残高が正しい
- [ ] 試算表の借方・貸方合計が一致している
- [ ] 損益計算書の数値が正しい
- [ ] 貸借対照表の数値が正しい
- [ ] 貸借対照表の資産合計 = 負債・純資産合計

### 6. 税抜経理の消費税計算
**手順:**
1. 設定で税抜経理が有効になっていることを確認
2. 課税仕入の仕訳を作成（例: 通信費3,000円）
3. 自動で仮払消費税が計算されることを確認
4. 仕訳を編集して金額を変更（例: 5,000円に変更）
5. 仮払消費税が再計算されることを確認

**確認項目:**
- [ ] 税込3,000円 → 税抜2,728円 + 消費税272円
- [ ] 税込5,000円 → 税抜4,546円 + 消費税454円
- [ ] 借方・貸方の合計が必ず一致している
- [ ] 編集後も消費税が正しく再計算される

### 7. 締め済み期間のロック
**手順:**
1. 設定ページで月次締めを実行
2. 締め済み期間の仕訳を編集・削除しようとする
3. エラーメッセージが表示されることを確認

**確認項目:**
- [ ] 締め済み仕訳は編集できない
- [ ] 締め済み仕訳は削除できない
- [ ] 適切なエラーメッセージが表示される

## バリデーションエラーのテスト

### 8. 不正な金額入力
**手順:**
1. 仕訳を編集
2. 借方・貸方の合計が一致しないように変更
3. 保存しようとする

**確認項目:**
- [ ] 「借方と貸方の合計が一致していません」エラーが表示される
- [ ] 仕訳は更新されない

### 9. 無効な勘定科目
**手順:**
1. ブラウザの開発者ツールで勘定科目IDを無効な値に変更
2. 保存しようとする

**確認項目:**
- [ ] 「無効な勘定科目が含まれています」エラーが表示される
- [ ] 仕訳は更新されない

## パフォーマンステスト

### 10. 大量データでの動作確認
**手順:**
1. 100件以上の仕訳を作成
2. 仕訳帳・総勘定元帳を表示
3. 編集・削除を実行

**確認項目:**
- [ ] ページの読み込みが5秒以内
- [ ] 編集・削除後のデータ更新が3秒以内
- [ ] ブラウザがフリーズしない

## 修正内容の技術的詳細

### 実装済みの機能
1. **仕訳帳に編集・削除ボタン追加** (`components/journal-report.tsx`)
2. **総勘定元帳に編集・削除ボタン追加** (`components/general-ledger-report.tsx`)
3. **削除確認ダイアログ実装**
4. **編集時のデータ読み込みとフォーム連携**
5. **税処理後の借方・貸方バランスチェック** (`lib/journal-entry-validation.ts`)

### データ整合性の保証
- 削除時に以下のクエリを自動無効化:
  - `journal-report` (仕訳帳)
  - `general-ledger` (総勘定元帳)
  - `journal-entries` (仕訳一覧)
  - `trial-balance` (試算表)
  - `reports` (全レポート)
  - `dashboard` (ダッシュボード)

- 更新時のバリデーション:
  1. 入力値の借方・貸方チェック
  2. 税込→税抜変換
  3. **変換後の借方・貸方チェック** (追加)
  4. データベース更新
  5. 関連クエリの自動更新

### 税抜経理の計算ロジック
```
税込金額から消費税を計算:
  消費税 = floor(税込 × 税率 / (1 + 税率))

税抜金額を逆算:
  税抜 = 税込 - 消費税

例: 税込3,000円、税率10%の場合
  消費税 = floor(3,000 × 0.1 / 1.1) = floor(272.727...) = 272円
  税抜 = 3,000 - 272 = 2,728円
```

## トラブルシューティング

### 借方・貸方が一致しないエラー
- 税抜経理の場合、入力は税込金額で行う
- システムが自動で税抜に変換し、消費税を追加
- 相手勘定（現金・預金等）も税込金額で入力

### 削除できないエラー
- 締め済み期間の仕訳は削除不可
- 設定ページで締め期間を確認・再開

### データが更新されない
- ブラウザをリロード
- React Query のキャッシュが原因の可能性
- 開発者ツールのコンソールでエラーを確認
